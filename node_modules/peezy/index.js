	
	var path = require("path"),
		express = require("express"),
		fileHelper = require("peezy-file-helper");
	
	var peezy = {};
	
// module init
	
	peezy.init = function(app_config, cb) {
	
		// get site config
		
			var site_config = require(path.join(app_config.dirname, app_config.folder, "/site.json"));
	
		// build vars
	
			// build folders object
			var folders = {};
			
			for (sub in app_config.subfolders) {
				folders[sub] = path.join(app_config.folder, app_config.subfolders[sub]);
			}
			
			// build paths object	
			var paths = {};	
			
			paths.themes = "/" + folders.themes;
			paths.themes_abs = path.join(app_config.dirname, folders.themes);
			paths.themes_rel = "/" + app_config.subfolders["themes"];
			
			paths.content = path.join(folders.content);
			paths.homepage = path.join(paths.content, site_config.homepage);	
			paths.error = path.join(paths.content, site_config.error);
			
			paths.public_abs = path.join(app_config.dirname, folders.public);
		
			// other vars
			var test_mode = true;
			
		// express setup
			
			// instantiate express
			var app = express();
			var port = process.env.PORT || app_config.port;
			
			// set view engine
			app.set("view engine", "ejs");
			
			// serve theme static files
			app.use(paths.themes_rel, express.static(paths.themes_abs));	
		
			// serve root static files
			app.use("/", express.static(paths.public_abs));	
	
		// routing
		
			var router = express.Router();
			
			// index
			
				router.get("/", function(req, res) {
					req.slug = site_config.homepage;
				    renderTemplate("index", req, res);
				});
			
			// pages
			
				router.get("/:slug", function(req, res) {
					// if req passed the param filter, render the theme
					if (req.slug) renderTemplate("index", req, res);
				});
				
				router.param("slug", function(req, res, next, slug) {
		
					// if request is not an asset file		
					if (slug.indexOf(".") == -1) {
				
						// assign the slug	
					    req.slug = slug;
				    
				    }
				    
				    next(); 
				    
				});
			
			// apply routes and start the server
			
				app.use('/', router);		
				app.listen(port);
				
			// optional callback	
				
				if (cb) cb();
			
		// functions
		
			function loadTheme(theme, app) {

				// set vars
				paths.theme = path.join(folders.themes, theme);
				paths.theme_abs = path.join(app_config.dirname, paths.theme);
								
				// load folder
				app.set("views", paths.theme_abs);							
				
			}
		
			function renderTemplate(template, req, res) {
				
				var render_theme;
				
				// if theme override
				if (req.query.theme) render_theme = req.query.theme;
				else render_theme = site_config.theme;
				
				// set internal vars
				var theme_path = paths.join(paths.themes, render_theme);
				var theme_path_abs = paths.join(paths.themes_abs, render_theme);				
				
				// load theme
				loadTheme(render_theme, app);
				
				// load theme config
				var theme_config = require(paths.join(theme_path_abs, "theme.json"));
				
				// if template or inc override
				if (req.query.template) template = req.query.template;
				if (req.query.inc) template = path.join("inc", req.query.inc);
					
				// build locals
				var locals = site_config;				
				
				locals.theme = render_theme;
				locals.themePath = theme_path;
				locals.slug = req.slug;
				locals.template = template;
								
				// if parent theme
				if (theme_config.parent) {
					// set parent locals
					locals.parent = theme_config.parent;
					locals.parentPath = paths.join(paths.themes, paths.parent);
				}
				
				locals.content = getContent(req.slug);
				
				// render view
				res.render(template, locals);
			
			}
		
			function getContent(slug) {
			
				var filepath = path.join(paths.content, slug);
				var error = path.join(paths.content, site_config.error);
			
				if (fileHelper.exists(filepath + ".html")) return fileHelper.readSync(filepath);
				else return fileHelper.readSync(error);
					
			}
			
	}
	
	module.exports = peezy;