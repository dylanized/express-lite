// module setup
	
	// libraries
	var path = require("path"),
		express = require("express"),
		compress = require("compression"),
		errorhandler = require("errorhandler"),
		_ = require("underscore");
		
	// peezy modules
	var	peezyLogger = require("./modules/peezy-logger.js"),
		fileHelper = require("peezy-file-helper"),
		buildPaths = require("./modules/build-paths.js"),
		contentLoader = require("./modules/content-loader.js"),
		themeEngine = require("./modules/theme-engine.js"),
		renderMinified = require("./modules/render-minified.js");
		
	var peezy = {};
	
// module init

	peezy.init = function(app_config) {
	
		if (!process.env.NODE_ENV || process.env.NODE_ENV != "production") peezyLogger.enable();
		
		var config = {};
		var pages = {};		
			
		// app config

			config.app = app_config;
		
			if (!config.app.appBase) config.app.appBase = path.join(__dirname, "../../");
			if (!config.app.siteFolder) config.app.siteFolder = "site";
			if (!config.app.siteBase) config.app.siteBase = path.join(config.app.appBase, config.app.siteFolder);
			
			peezy.log("Initializing app:", config.app);
			
		// site config
		
			config.site = require(path.join(config.app.siteBase, "site.json"));			
			peezy.log("Loading site:", config.site);

			config.paths = buildPaths(config.app, config.site);			
			peezy.log("Paths built:", config.paths);
		
			peezy.config = config;				
			
		// load content
		
			peezy.content = {};
		
			peezy.content.pages = contentLoader.getPages(config.paths.contentBase);			
			peezy.pages = peezy.content.pages;
			
			peezy.inspect(peezy.pages, "Pages Loaded");
			
	}	

	peezy.serve = function(app_config, cb) {
	
		// setup
		
			peezy.init(app_config);
		
			// instantiate express
			var app = express();
			var port = process.env.PORT || peezy.config.app.port;
			
			// set view engine
			app.set("view engine", "ejs");
			
			// if dev mode		
			if (app.get('env') == "development") {
				// error handler
				app.use(errorhandler());
			}
			
			// else if production mode
			else if (app.get('env') == "production") {
				// minify html
				app.use(renderMinified);
			}
		
			// serve theme static files
			app.use(peezy.config.paths.themes, express.static(peezy.config.paths.themesBase));	
		
			// serve root static files
			app.use("/", express.static(peezy.config.paths.publicBase));	
			
			// gzip compression
			app.use(compress());
				
			peezy.theme.init(peezy.config, app);				
			peezy.themes = peezy.theme.locals.themes;
			
			peezy.inspect(peezy.themes, "Themes Loaded");
				
		// routing
		
			var router = express.Router();
			
			// index			
			router.get("/", function(req, res) {
				// render homepage
				peezy.log("Request: homepage", false);
			    peezy.handler(peezy.config.site.homepage, req, res);
			});
			
			// pages
			router.get(/^\/((?:[^\/]+\/?)+)\/?/, function(req, res) {					
			
				var slug = req.params[0];
				// remove optional trailing slash
				if(slug.substr(-1) === '/') slug = slug.substr(0, slug.length - 1);
				
				// handle requested page
				peezy.log("Request: " + slug, false);
				peezy.handler(slug, req, res);
				
			});
				
			// apply routes
			app.use('/', router);
				
			// default route				
			app.use(function(req, res){
				// render error page
				peezy.log("Request: error", false);				
				peezy.handler(peezy.config.site.error, req, res);
			});				
		
		// finish up
		
			// start server
			app.listen(port);
				
			// optional callback	
			if (cb) cb();		
	
	}
	
	peezy.handler = function(slug, req, res) {
	
		if (peezy.pages) {
		
			// load page or error
			if (peezy.pages[slug]) peezy.theme.setPage(peezy.pages[slug]);
			else peezy.theme.setError(peezy.pages[peezy.config.site.error]);
			
			// set theme and template
			peezy.theme.setTheme(req.query);
			peezy.theme.setTemplate(peezy.pages[slug], req.query);
			
			// launch view engine
			peezy.theme.render(res, peezy.content);
		
		}
		
	}	
	
	peezy.log = function(arg1, arg2) {
		peezyLogger.log(arg1, arg2);
	}
	
	peezy.inspect = function(arr, msg) {
		peezyLogger.inspect(arr, msg);
	}
	
	peezy.theme = themeEngine;
	
	module.exports = peezy;