// module setup
	
	// libraries
	var path = require("path"),
		express = require("express"),
		compress = require("compression"),
		errorhandler = require("errorhandler"),
		_ = require("underscore");
		
	// peezy modules
	var	fileHelper = require("peezy-file-helper"),
		buildPaths = require("./modules/build-paths.js"),
		contentLoader = require("./modules/content-loader.js"),
		themeEngine = require("./modules/theme-engine.js"),
		renderMinified = require("./modules/render-minified.js");
		
	var peezy = {};
	
	var test_mode = true;
	
// module init

	peezy.init = function(app_config, cb) {
	
		//test_msg("Initializing App:", app_config);	
	
		// base folders
		
			if (!app_config.appBase) app_config.appBase = path.join(__dirname, "../../");
			if (!app_config.siteFolder) app_config.siteFolder = "site";
			if (!app_config.siteBase) app_config.siteBase = path.join(app_config.appBase, app_config.siteFolder);
			
		// config and vars
		
			var site_config = require(path.join(app_config.siteBase, "site.json"));			
			//test_msg("Loading Site:", site_config);

			var paths = buildPaths(app_config, site_config);	
						
		// express init
			
			// instantiate express
			var app = express();
			var port = process.env.PORT || app_config.port;
			
			// set view engine
			app.set("view engine", "ejs");
			
			// serve theme static files
			app.use(paths.themes_rel, express.static(paths.themesBase));	
		
			// serve root static files
			app.use("/", express.static(paths.publicBase));	
			
			// gzip compression
			app.use(compress());

			// dev mode		
			if (app.get('env') == "development") {
				// error handler
				app.use(errorhandler());
			}
			
			// production mode
			else if (app.get('env') == "production") {
				// minify html
				app.use(renderMinified);
			}		
								
		// peezy init
		
			var pages = contentLoader.getPages(paths.contentBase);
			
			themeEngine.init(app_config, site_config, app);			
	
		// routing
		
			var router = express.Router();
			
			// index			
			router.get("/", function(req, res) {
				// render homepage
			   handleReq(site_config.homepage, req, res);
			});
			
			// pages
			router.get(/^\/((?:[^\/]+\/?)+)\/?/, function(req, res) {					
			
				var slug = req.params[0];
				// remove optional trailing slash
				if(slug.substr(-1) === '/') slug = slug.substr(0, slug.length - 1);
				
				// render requested page
				handleReq(slug, req, res);
				
			});
				
			// apply routes
			app.use('/', router);
				
			// default route				
			app.use(function(req, res){
				// render error page
				handleReq(site_config.error, req, res);
			});				
		
			// start server
			app.listen(port);
				
			// optional callback	
			if (cb) cb();
			
		// functions
		
			function handleReq(slug, req, res) {
			
				// load page or error
				if (pages[slug]) themeEngine.setPage(pages[slug]);
				else themeEngine.setError(pages[site_config.error]);
				
				// set theme and template
				themeEngine.setTheme(req.query);
				themeEngine.setTemplate(slug, req.query);
				
				// launch view engine
				themeEngine.render(res);
				
			}
			
	}
	
	module.exports = peezy;