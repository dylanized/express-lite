// setup

	var path = require("path"),
	 	fileHelper = require("peezy-file-helper"),
	 	_ = require("underscore");

	var ThemeEngine = {};
	
// initialize

	var locals = {};
	
	ThemeEngine.init = function(app_config, site_config, app) {
		
		app_config.themesBase = path.join(app_config.siteBase, app_config.folders.themes);
		
		locals.app = _.clone(app_config);
		locals.site = _.clone(site_config);
		
		this.loadThemes();
		
		this.app = app;
	
	}
	
// load themes
	
	ThemeEngine.loadThemes = function() {
	
		var themes = fileHelper.getFolders(locals.app.themesBase);	

		// for each theme
		for (var i = 0; i < themes.length; i++) {
		
			// if required files dont exist, delete from theme list
			var theme_config = path.join(locals.app.themesBase, themes[i], "theme.json");
			var theme_index = path.join(locals.app.themesBase, themes[i], "index.ejs");
		
			if (!fileHelper.exists([theme_config, theme_index])) themes.splice(i, 1);
		
		}
	
		this.themes = themes;	
	
	}
	
// set status

	ThemeEngine.setPage = function(page, err) {
		
		if (err) page.status = 404;
		else page.status = 200;
		
		locals.page = _.clone(page);
	
	}
			
// set error

	ThemeEngine.setError = function(page) {	
		this.setPage(page, true);	
	}
	
// set theme

	ThemeEngine.setTheme = function(query) {
	
		var theme = {};

		// theme override	
		if (query && query.theme && this.themes.indexOf(query.theme) > -1) theme.slug = query.theme;
		else theme.slug = locals.site.theme;
					
		// paths
		theme.path = "/" + locals.app.folders.themes + "/" + theme.slug;
		theme.base = path.join(locals.app.themesBase, theme.slug);
		
		// load config
		var config = require(path.join(theme.base, "theme.json"));
		_.extend(theme, config);
		
		// set theme
		locals.theme = theme;
				
		// if child theme theme
		if (config.parent) {
			var parent = {};
			// set parent theme locals
			parent.slug = config.parent;
			parent.path = "/" + locals.app.folders.themes + "/" + config.parent;
			locals.parent = parent;
		}		

	}	

// get template

	ThemeEngine.setTemplate = function(slug, query) {
	
		var template = {};

		// if inc override
		if (query && query.inc && this.templateExists(locals.theme.slug, "inc/" + query.inc)) template.slug = "inc/" + query.inc;
		
		// else if query override
		else if (query && query.template && this.templateExists(locals.theme.slug, query.template)) template.slug = query.template;
		
		// else if meta data
		
		// else if homepage
		
		// else default
		else template.slug = "index";
		
		template.file = template.slug + ".ejs";
		
		locals.template = template;

	}
		
// if template exists

	ThemeEngine.templateExists = function(theme, template) {
	
		var filepath = path.join(locals.app.themesBase, theme, template + ".ejs");
		if (fileHelper.exists(filepath)) return true;
		else return false;
	
	}
	
// render

	ThemeEngine.render = function(res) {

		this.app.set("views", locals.theme.base);							
		res.status(locals.page.status).render(locals.template.file, locals);
	
	}
	
// locals

	ThemeEngine.locals = locals;
	
// instantiate		

module.exports = ThemeEngine;